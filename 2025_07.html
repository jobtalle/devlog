<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="initial-scale=1"><meta name="description" content="The Koi Farm 2 development blog"><title>Koi Farm 2 blog | July 2025</title><link rel="stylesheet" type="text/css" href="style.css"><link rel="icon" type="image/png" sizes="16x16" href="favicon_16.png"/><link rel="icon" type="image/png" sizes="32x32" href="favicon_32.png"/><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="rss.xml"></head><body><div id="wrapper"><div id="content"><input type="checkbox" id="dropdown-menu" class="dropdown-checkbox"><label for="dropdown-menu" id="menu-toggle"><span></span></label><div id="index" class="dropdown-menu"><ul><li><a title="Going cross-platform" href="2025_12.html">December 2025</a></li><li><a title="Terrain detailing" href="2025_11.html">November 2025</a></li><li><a title="A tiny distraction" href="2025_10.html">October 2025</a></li><li><a title="Grass" href="2025_09.html">September 2025</a></li><li><a title="Holland Koi Show" href="2025_08.html">August 2025</a></li><li>July 2025</li><li><a title="Making waves" href="2025_06.html">June 2025</a></li><li><a title="The grid" href="2025_05.html">May 2025</a></li><li><a title="Tessellation" href="2025_04.html">April 2025</a></li><li><a title="Patterns" href="2025_03.html">March 2025</a></li><li><a title="Memory management" href="2025_02.html">February 2025</a></li><li><a title="The koi are back" href="2025_01.html">January 2025</a></li><li><hr></li><li><a title="Porting progress" href="2024_12.html">December 2024</a></li><li><a title="A new engine" href="2024_11.html">November 2024</a></li><li><a title="Leaving the prototype phase" href="2024_10.html">October 2024</a></li><li><a title="Koi farms in Japan" href="2024_09.html">September 2024</a></li><li><a title="Water & fin colors" href="2024_08.html">August 2024</a></li><li><a title="Pattern genetics" href="2024_07.html">July 2024</a></li><li><a title="The first patterns" href="2024_06.html">June 2024</a></li><li><a title="Shadows, textures and fins" href="2024_05.html">May 2024</a></li><li><a title="Animation" href="2024_04.html">April 2024</a></li><li><a title="Rigging fins" href="2024_03.html">March 2024</a></li><li><a title="Koi modelling" href="2024_02.html">February 2024</a></li><li><a title="Interactive koi" href="2024_01.html">January 2024</a></li><li><hr></li><li><a title="Moving to 3d" href="2023_12.html">December 2023</a></li><li><a title="Pond digging" href="2023_11.html">November 2023</a></li><hr></ul><a href="rss.xml" title="RSS"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24.912 24.912"><g><path d="M3.692,17.517C1.656,17.517,0,19.173,0,21.211C0,23.244,1.656,24.9,3.692,24.9s3.694-1.657,3.694-3.689C7.387,19.173,5.729,17.517,3.692,17.517z"/><path d="M0.384,8.142C0.173,8.142,0,8.315,0,8.527v4.688c0,0.211,0.173,0.383,0.384,0.383c6.02,0,10.919,4.898,10.919,10.92c0,0.209,0.171,0.383,0.384,0.383h4.689h0.016c0.215,0,0.387-0.173,0.387-0.383l-0.018-0.121C16.692,15.423,9.37,8.142,0.384,8.142z"/><path d="M24.89,24.397C24.825,10.936,13.854,0.011,0.384,0.011C0.173,0.011,0,0.183,0,0.397v4.824c0,0.212,0.173,0.383,0.384,0.383c10.429,0,18.913,8.486,18.913,18.914c0,0.209,0.172,0.383,0.382,0.383h4.825h0.02c0.21,0,0.388-0.173,0.388-0.383L24.89,24.397z"/></g></svg></a><a href="https://x.com/jobtalle" target="_blank" title="X"><svg class="icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg></a><a href="https://discord.gg/bw3ZFe63Qg" target="_blank" title="Discord"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 126.644 96"><path d="M81.15,0c-1.2376,2.1973-2.3489,4.4704-3.3591,6.794-9.5975-1.4396-19.3718-1.4396-28.9945,0-.985-2.3236-2.1216-4.5967-3.3591-6.794-9.0166,1.5407-17.8059,4.2431-26.1405,8.0568C2.779,32.5304-1.6914,56.3725.5312,79.8863c9.6732,7.1476,20.5083,12.603,32.0505,16.0884,2.6014-3.4854,4.8998-7.1981,6.8698-11.0623-3.738-1.3891-7.3497-3.1318-10.8098-5.1523.9092-.6567,1.7932-1.3386,2.6519-1.9953,20.281,9.547,43.7696,9.547,64.0758,0,.8587.7072,1.7427,1.3891,2.6519,1.9953-3.4601,2.0457-7.0718,3.7632-10.835,5.1776,1.97,3.8642,4.2683,7.5769,6.8698,11.0623,11.5419-3.4854,22.3769-8.9156,32.0509-16.0631,2.626-27.2771-4.496-50.9172-18.817-71.8548C98.9811,4.2684,90.1918,1.5659,81.1752.0505l-.0252-.0505ZM42.2802,65.4144c-6.2383,0-11.4159-5.6575-11.4159-12.6535s4.9755-12.6788,11.3907-12.6788,11.5169,5.708,11.4159,12.6788c-.101,6.9708-5.026,12.6535-11.3907,12.6535ZM84.3576,65.4144c-6.2637,0-11.3907-5.6575-11.3907-12.6535s4.9755-12.6788,11.3907-12.6788,11.4917,5.708,11.3906,12.6788c-.101,6.9708-5.026,12.6535-11.3906,12.6535Z"/></svg></a></div><div id="blog"><div id="post"><h2>Shadows</h2><h3>July 2025</h3><p>Up until this point I've already had simple shadows, but these were just projected in a fixed size square region around the camera focus area. That meant that distant shadows broke down. When doing shadows well, it's important that they work in all sorts of situations.</p><p>Shadows are rendered by rendering the scene twice: first, the scene is rendered from the perspective of a light source casting shadows, like the sun. No colors or shading are calculated in this pass, just depth values relative to the light source. Then, when the scene is rendered fully, every shadow receiving pixel first calculates where their pixel lies on the shadow render target, and then they evaluate whether they are further away than the nearest object to the light source or not. If they are further away, that means the light source was obstructed and a shadow needs to be cast.</p><p>That part worked. The tricky part is calculating where shadows need to be rendered, and keeping the amount of detail high enough to prevent pixelated shadows. A few problems emerge:</p><ul><li>Shadow quality needs to scale with zoom. When looking at fish from nearby, the quality of the shadows needs to be higher.</li><li>The visible area does not have a square shape, so a texture won't fit over it nicely. The <a href="2025_05.html" target="_blank">May update</a> shows the shape of a visible area on the scene grid.</li><li>When the camera looks towards the horizon, you can see very far away. The shadow texture has limited size, and it's too small to contain shadows for hundreds of meters of scenery at sufficient detail.</li></ul><p>To solve these issues, I go through a number of steps to calculate the shadow projection:</p><figure><img src="posts\2025_07\shadows.jpg" width="400" height="366" alt="The shadow projection"><figcaption>The shadow projection</figcaption></figure><ol><li>I take the visibility polygon from the grid algorithm, which is a shape with four points in which all visible things are contained.</li><li>I calculate a "horizon" beyond which no shadows are rendered. This horizon is defined by an angle; if the angle between the ground surface and the direction of incoming view vectors is smaller than a certain value, it is considered "beyond the horizon", it's far enough that no shadows or other detailed effects need to be rendered. The visibility polygon is then cropped to only contain the area that's closer than the horizon threshold.</li><li>The resulting shape is projected from the light perspective.</li><li>I fit a square shape around the projected shape, because the shadow render target is also square.</li><li>Shadows are rendered to that square region.</li></ol><p>This ensures that shadows are rendered for visible regions that are close enough to the camera. The shadow-mapped region is smaller when zoomed in, so shadows will be more detailed when they need to be. Because the shadow map may be cut off beyond the horizon, if the horizon is in view, I also fade out shadows as they get near the horizon line, so no hard cut can be seen.</p><figure><img src="posts\2025_07\softShadow.jpg" width="300" height="394" alt="Soft shadow edges"><figcaption>Soft shadow edges</figcaption></figure><p>The image shows what's going on: the big yellow arrow is the sun direction. The white quad shows the visible water area in this scene, the blue quad below it shows the visible underwater area, and the yellow box encompasses everything. Shadows will be rendered inside the box, the shadow map is created by rendering the contents of the box to a texture.</p><p>Shadows are also softer now. Instead of just sampling one value from the shadow map, several values are sampled and averaged to create smooth transitions between shadow borders. Realistically, shadows should become softer when the shadow casting object is further away from the shadow receiving object. This is called <dfn>contact hardening</dfn>, and it's something I've yet to try.</p><p>So far, only things between the pond floor and the surface cast and receive shadows, mostly because there's nothing above the ground. That will soon change though, because I've started working on vegetation rendering. I'm not sure yet whether (small) vegetation should cast and receive shadows using this same technique. There are alternatives that may work better for small details, like a combination of ambient occlusion and screen space shadows, while very large objects still cast shadows in the normal way.</p></div><div id="footer"><span class="previous"><a href="2025_06.html"><< previous</a></span><span id="copyright">Â© Job Talle 2023 - 2026</span><span class="next"><a href="2025_08.html">next >></a></span></div></div></div></div></body></html>