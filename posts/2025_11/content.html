<h2>Terrain detailing</h2>
<p>Before adding more complex plants and objects to the scene, I want to develop my terrain system a bit further. The current system is just a flat plane with a single color in which ponds can be dug. I need the following features:</p>
<ul>
    <li>Elevation (above as well as below the height ponds are at).</li>
    <li>Colorization and texturing. It's really important that plants aren't just planes sticking out of the ground, because it looks messy and fake. The colors of grass and plants need to blend into the terrain seamlessly.</li>
    <li>A level of detail system similar to water, which ensures that enough detail exists when zooming in to a patch of ground, while not wasting processing power for distant hills.</li>
</ul>
<figure>
    <img src="grid.webp" alt="The terrain grid">
    <figcaption>The terrain grid</figcaption>
</figure>
<p>The entire terrain surface was a scene sized quad up until now, but I need tessellated tiles to render hills. Because water tiles and ground tiles have the same size that both need to vary in their level of detail, I've used the water tessellating system to render ground tiles. A heightmap is generated for every scene and rendered to a texture, and the terrain reads that texture when rendering to displace terrain.</p>
<p>Because the terrain can now take any shape, I also have to calculate the surface normals for lighting. I calculate them from the heightmap and store them in a texture, which is sampled when rendering terrain and when rendering plants. Plants need these normals in order to blend into the terrain, since the base of each plant needs to be lit in the same way as the terrain under it.</p>
<figure>
    <img src="textures.webp" alt="Terrain textures">
    <figcaption>Terrain textures</figcaption>
</figure>
<p>With heightmaps, scenes are no longer simply squares that can be dug out. I've created a <dfn>map</dfn> class, which contains all information required to construct a scene:</p>
<ul>
    <li>The size of the scene.</li>
    <li>The heightmap, or a recipe to procedurally generate it.</li>
    <li>A random seed that's used to procedurally place the initial objects.</li>
    <li>The allowed area the player can build in (which is usually every flat part of the heightmap).</li>
</ul>
<p>Maps will probably be extended later with things like scenery, unlockable areas and things like weather options. Maps configurations can be stored, loaded, generated and randomized. While I'm not exactly sure how maps will be editable and usable by the player, I'm sure the system will come in handy in the future.</p>
<figure>
    <img src="colorization.webp" alt="Terrain colorization">
    <figcaption>Terrain colorization</figcaption>
</figure>
<p>The terrain should behave like a chameleon: it takes the color of things that exist on it to make them blend in. If there's a patch of grass, the terrain needs to be green in that area, and the ground under rocks or statues should be sand or rock colored. To do this, I've created a texture that spans the entire area in a scene. When the objects on a patch of ground change, that part of the texture is cleared and re-rendered by rendering a colored flare (a <dfn>splat</dfn>) at the location of each object. Grass models would for example render a green flare under them. Later, when grass is rendered, the lower part of the grass model takes its color directly from the terrain texture, while it fades towards its own color as the model extends higher above the ground.</p>
<p>This system creates a kind of feedback loop that matches the ground and the objects on it to each other:</p>
<ol>
    <li>An object is placed,</li>
    <li>the ground texture in the area the object is placed in will be cleared,</li>
    <li>for every object in that area, a colored flare is rendered,</li>
    <li>and finally, when the object renders, it fades towards the terrain texture color where the object intersects the terrain.</li>
</ol>
<p>The image above shows the three textures I'm currently using to render terrain:</p>
<ol>
    <li>The heightmap.</li>
    <li>The normal map, which stores the X and Z components of the normal vector. The Y component can be reconstructed programmatically.</li>
    <li>The colorization, which is currently still quite simple.</li>
</ol>
<p>These new features give me some of the tools I'll need to make koi farm 2 pretty, but there are still some things that can be improved. The ground color texture is still quite simple, every blade of grass produces the same green for example. It'd be nicer if the hue varies a bit, and adapts to the terrain shape. The texture is also rather low resolution, so it doesn't show small details like leaves and moss on the ground. Those details shouldn't exist in this texture, since it needs to span the entire map and it only stores color, but I can add those details by overlapping some repeating detail textures.</p>