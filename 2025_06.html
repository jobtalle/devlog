<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Koi Farm 2 blog | June 2025</title><link rel="stylesheet" type="text/css" href="style.css"><link rel="icon" type="image/png" sizes="16x16" href="favicon_16.png"/><link rel="icon" type="image/png" sizes="32x32" href="favicon_32.png"/><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="rss.xml"></head><body><div id="wrapper"><div id="content"><div id="index"><ul><li>June 2025</li><li><a href="2025_05.html">May 2025</a></li><li><a href="2025_04.html">April 2025</a></li><li><a href="2025_03.html">March 2025</a></li><li><a href="2025_02.html">February 2025</a></li><li><a href="2025_01.html">January 2025</a></li><li><hr></li><li><a href="2024_12.html">December 2024</a></li><li><a href="2024_11.html">November 2024</a></li><li><a href="2024_10.html">October 2024</a></li><li><a href="2024_09.html">September 2024</a></li><li><a href="2024_08.html">August 2024</a></li><li><a href="2024_07.html">July 2024</a></li><li><a href="2024_06.html">June 2024</a></li><li><a href="2024_05.html">May 2024</a></li><li><a href="2024_04.html">April 2024</a></li><li><a href="2024_03.html">March 2024</a></li><li><a href="2024_02.html">February 2024</a></li><li><a href="2024_01.html">January 2024</a></li><li><hr></li><li><a href="2023_12.html">December 2023</a></li><li><a href="2023_11.html">November 2023</a></li><hr></ul><a href="rss.xml"><svg height="16px" width="16px" class="icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24.912 24.912" xml:space="preserve"><g><path d="M3.692,17.517C1.656,17.517,0,19.173,0,21.211C0,23.244,1.656,24.9,3.692,24.9s3.694-1.657,3.694-3.689,C7.387,19.173,5.729,17.517,3.692,17.517z"/><path d="M0.384,8.142C0.173,8.142,0,8.315,0,8.527v4.688c0,0.211,0.173,0.383,0.384,0.383c6.02,0,10.919,4.898,10.919,10.92,c0,0.209,0.171,0.383,0.384,0.383h4.689h0.016c0.215,0,0.387-0.173,0.387-0.383l-0.018-0.121C16.692,15.423,9.37,8.142,0.384,8.142,z"/><path d="M24.89,24.397C24.825,10.936,13.854,0.011,0.384,0.011C0.173,0.011,0,0.183,0,0.397v4.824c0,0.212,0.173,0.383,0.384,0.383,c10.429,0,18.913,8.486,18.913,18.914c0,0.209,0.172,0.383,0.382,0.383h4.825h0.02c0.21,0,0.388-0.173,0.388-0.383L24.89,24.397z"/></g></svg></a><a href="https://x.com/jobtalle" target="_blank"><svg height="16px" width="16px" class="icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" xml:space="preserve"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg></a></div><div id="blog"><div id="post"><h2>Making waves</h2><h3>June 2025</h3><p>One of my goals is to make the environment feel as dynamic and alive as possible. In koi farm 1, I simulated all the waves in the scene instead of just looping a waves animation or using some shader trick to render waves; every wave in the game was at some point caused by a fish, a raindrop or the user, and waves bounce, combine and travel across the scene as time passes. For koi farm 2, I want that too, but better of course. There are a few extra things to consider this time:</p><ul><li>While koi farm 1 had a very limited scene, environments can be bigger now. Simulating waves for all existing water wastes too many GPU cycles.</li><li>The waves need to be 3D this time.</li><li>Pond shapes are completely unpredictable because players design their own ponds, the water simulation needs to work in any case.</li><li>Simulating refraction in 3D is not trivial unless you're raytracing.</li></ul><p>Many ingredients go into rendering believable water:</p><ul><li>Objects below the water surface are colored slightly differently.</li><li>Some objects are partially submerged, like plants.</li><li>When light travels from air to water, <em>refraction</em> occurs. Light moves through the water surface at an angle creating distortion.</li><li>Water is very reflective, it should reflect the scenery around it and the sky above.</li><li>Waves change shape all the time, and the water needs to animate these waves at a sufficiently high resolution.</li></ul><figure><img src="posts\2025_06\waveHeight.gif" alt="The wave simulation"><figcaption>The wave simulation</figcaption></figure><p>The wave simulation uses the same algorithm koi farm 1 used. This works well enough to create and propagate waves, and reflecting those waves back from shores with arbitrary shapes. The simulation gives me an image which contains the wave altitude on every pixel. To keep things performant, the simulation only runs for water in a fixed size area centered around the camera. When the player changes perspective, the simulation moves with the camera to simulate water wherever required. The wave simulation also only updates waves where water actually exists. To do this, I render the scene altitude from a top-down perspective, and I use this heightmap as a depth buffer while rasterizing the next wave simulation image state. The animation shows the wave height as a grayscale value; the bright dot moving from the right to the left is a fish swimming near the surface of the water causing waves.</p><figure><img src="posts\2025_06\distortion.gif" alt="Wave mesh distortion"><figcaption>Wave mesh distortion</figcaption></figure><p>The wave simulation algorithm gives me rather smooth waves which look similar to sine waves when viewed from the side. This is not how real waves look, and they don't feel right when rendered in 3D. The peaks of higher waves are somewhat sharp, while the spaces in between are smoother. <a href="2025_05.html">Last month's isotropic water mesh</a> comes in very handy: it's pretty resistant to self occlusion and warping, so I can move its vertices in the direction of the derivative of the wave simulation texture without messing up the geometry. This creates precisely the desired effect. Waves are sharp at the crest and the troughs are wider and smooth.</p><figure><img src="posts\2025_06\refraction.jpg" alt="Ray-traced refraction"><figcaption>Ray-traced refraction</figcaption></figure><p>Rendering refraction turned out to be a major issue. When using ray-tracing techniques it's pretty trivial, but I can't rely on users running hardware with these capabilities, and the koi models will be way too complex to ray-trace efficiently. I've tried <em>screen space refractions</em>, where I first rendered the underwater scene to an image, and then ray-traced into that image from every water surface pixel to find out what pixel should be visible there. The resulting distortion is physically correct, but the results weren't pixel perfect because I've had to limit the ray-tracing resolution to keep frame rate within acceptable levels, and tracing colors behind koi on a pre-rendered image is impossible. This created many false positive traces where a koi pixel was hit, while in reality a pixel <em>behind</em> the koi had to be retrieved. It's impossible to distinguish different "layers" of colors in a single image. The image on the right shows the result of this problem. some pixels get the right color, but whenever the refracted ray goes behind something, noisy artifacts show up instead of what you should have seen. The black and white koi in the top left is a great example: many rays hit behind the koi but return koi pixels instead, which extrudes the koi upwards.</p><p>Eventually, I settled on faking refraction convincingly:</p><figure><video autoplay loop muted playsinline width="500px"><source src="posts\2025_06\waves.webm" type="video/webm"></video><figcaption>Koi refracting through the waves</figcaption></figure><ol><li>Underwater objects are rendered to an image. Everything underwater is skewed upwards in a way that approximates the effect of refracting light rays, excluding shadows and depth based calculations.</li><li>The displacement magnitude for each water pixel is calculated based on the <em>angle of incidence</em> which is the angle at which the ray from the camera hits the water surface. This is a rough approximation for the distance an underwater ray travels, which affects the amount of distortion.</li><li>The underwater image is rendered on the water, but a displacement is applied based on the water surface normal and the previously calculated displacement magnitude.</li></ol><p>The video shows a test of this "fake refraction" effect. Koi displace an unrealistic amount of water above them for testing purposes. The only thing that remains are reflections of both the sky and plants on the pond shores, but since neither exist for now, I'll implement that later.</p></div><div id="footer"><span class="previous"><a href="2025_05.html"><< previous</a></span></div></div></div></div></body></html>